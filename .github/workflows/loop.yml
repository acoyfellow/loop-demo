name: Healing Loop

# Failure until success. Runs until all gates pass.
# PAUSED is your kill switch.

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent: opencode, claude, openai'
        default: 'opencode'
      force:
        description: 'Run even if PAUSED'
        default: 'false'

jobs:
  heal:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && github.actor != 'gateproof-bot'
    
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PAUSED
        id: paused
        run: |
          if [[ -f .gateproof/PAUSED ]] && [[ "${{ github.event.inputs.force }}" != "true" ]]; then
            echo "paused=true" >> $GITHUB_OUTPUT
          else
            echo "paused=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup
        if: steps.paused.outputs.paused != 'true'
        uses: oven-sh/setup-bun@v1
      
      - name: Install
        if: steps.paused.outputs.paused != 'true'
        run: bun install
      
      - name: Git config
        if: steps.paused.outputs.paused != 'true'
        run: |
          git config user.name "gateproof-bot"
          git config user.email "gateproof-bot@users.noreply.github.com"
      
      - name: Heal
        if: steps.paused.outputs.paused != 'true'
        env:
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          mkdir -p .gateproof
          
          # CI runs limited iterations
          for i in {1..3}; do
            [[ -f .gateproof/PAUSED ]] && { echo "PAUSED"; exit 0; }
            
            ITER=$(cat .gateproof/iteration 2>/dev/null || echo 0)
            ITER=$((ITER + 1))
            echo "$ITER" > .gateproof/iteration
            echo "=== Iteration $ITER ==="
            
            # Run PRD
            set -o pipefail
            if bun run prd.ts --report .gateproof/prd-report.json 2>&1 | tee .gateproof/output.txt; then
              echo "✅ All gates passed!"
              exit 0
            fi
            set +o pipefail
            
            # Call agent to fix
            bun run scripts/heal.ts || echo "Heal script failed"
            
            sleep 2
          done
          
          echo "CI batch done."
      
      - name: Commit changes
        if: steps.paused.outputs.paused != 'true'
        run: |
          git add .gateproof/ src/ || true
          git commit -m "heal: iteration $(cat .gateproof/iteration 2>/dev/null || echo '?')" || true
          git push || true
      
      - name: Summary
        if: always()
        run: |
          echo "## Healing Loop" >> $GITHUB_STEP_SUMMARY
          if [[ -f .gateproof/PAUSED ]]; then
            echo "⏸️ PAUSED" >> $GITHUB_STEP_SUMMARY
          elif [[ -f .gateproof/prd-report.json ]]; then
            cat .gateproof/prd-report.json >> $GITHUB_STEP_SUMMARY || true
          fi
