name: Healing Loop

# Failure until success. Runs until all gates pass.
# PAUSED is your kill switch.

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent: opencode, claude, openai'
        default: 'opencode'
      force:
        description: 'Run even if PAUSED'
        default: 'false'

jobs:
  heal:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && github.actor != 'gateproof-bot'
    
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PAUSED
        id: paused
        run: |
          if [[ -f .gateproof/PAUSED ]] && [[ "${{ github.event.inputs.force }}" != "true" ]]; then
            echo "paused=true" >> $GITHUB_OUTPUT
          else
            echo "paused=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup
        if: steps.paused.outputs.paused != 'true'
        uses: oven-sh/setup-bun@v1
      
      - name: Install
        if: steps.paused.outputs.paused != 'true'
        run: bun install
      
      - name: Git config
        if: steps.paused.outputs.paused != 'true'
        run: |
          git config user.name "gateproof-bot"
          git config user.email "gateproof-bot@users.noreply.github.com"
      
      - name: Heal
        if: steps.paused.outputs.paused != 'true'
        env:
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          mkdir -p .gateproof
          
          # Determine API key
          API_KEY="${OPENCODE_ZEN_API_KEY:-${ANTHROPIC_API_KEY:-$OPENAI_API_KEY}}"
          if [[ -z "$API_KEY" ]]; then
            echo "No API key found"
            exit 1
          fi
          
          # CI runs limited iterations
          for i in {1..3}; do
            [[ -f .gateproof/PAUSED ]] && { echo "PAUSED"; exit 0; }
            
            ITER=$(cat .gateproof/iteration 2>/dev/null || echo 0)
            ITER=$((ITER + 1))
            echo "$ITER" > .gateproof/iteration
            echo "=== Iteration $ITER ==="
            
            # Run PRD
            if bun run prd.ts --report .gateproof/prd-report.json 2>&1 | tee .gateproof/output.txt; then
              echo "✅ All gates passed!"
              exit 0
            fi
            
            # Get failure output
            FAILURE=$(cat .gateproof/output.txt | tail -50)
            PRD_CONTENT=$(cat prd.ts)
            
            # Call OpenCode Zen to fix
            echo "Calling agent to fix..."
            RESPONSE=$(curl -s -X POST "https://opencode.ai/zen/v1/chat/completions" \
              -H "Authorization: Bearer $API_KEY" \
              -H "Content-Type: application/json" \
              -d "$(jq -n \
                --arg prd "$PRD_CONTENT" \
                --arg failure "$FAILURE" \
                '{
                  model: "big-pickle",
                  messages: [{
                    role: "user",
                    content: "Fix this gateproof PRD failure. Output ONLY the file contents needed, no explanation.\n\nPRD:\n\($prd)\n\nFailure:\n\($failure)\n\nCreate or fix the file to make the gate pass. Output format:\n---FILE: path/to/file.ts---\nfile contents here\n---END---"
                  }],
                  max_tokens: 2000
                }')")
            
            # Parse response and write files
            CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
            if [[ -n "$CONTENT" ]]; then
              echo "$CONTENT" | while IFS= read -r line; do
                if [[ "$line" =~ ^---FILE:\ (.+)---$ ]]; then
                  CURRENT_FILE="${BASH_REMATCH[1]}"
                  mkdir -p "$(dirname "$CURRENT_FILE")"
                  > "$CURRENT_FILE"
                elif [[ "$line" == "---END---" ]]; then
                  echo "Wrote: $CURRENT_FILE"
                  CURRENT_FILE=""
                elif [[ -n "$CURRENT_FILE" ]]; then
                  echo "$line" >> "$CURRENT_FILE"
                fi
              done
            fi
            
            sleep 2
          done
          
          echo "CI batch done."
      
      - name: Commit state
        if: steps.paused.outputs.paused != 'true'
        run: |
          git add .gateproof/ || true
          git commit -m "heal: iteration $(cat .gateproof/iteration 2>/dev/null || echo '?')" || true
          git push || true
      
      - name: Summary
        if: always()
        run: |
          echo "## Healing Loop" >> $GITHUB_STEP_SUMMARY
          if [[ -f .gateproof/PAUSED ]]; then
            echo "⏸️ PAUSED" >> $GITHUB_STEP_SUMMARY
          elif [[ -f .gateproof/prd-report.json ]]; then
            cat .gateproof/prd-report.json >> $GITHUB_STEP_SUMMARY || true
          fi
